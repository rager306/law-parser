# Parsing Prompt for Russian Normative Acts Structure Extraction
# Version: 1.0.0
# Created: 2025-12-31
# Purpose: YAML prompt for DSPy GEPA/MIPROv2 optimization
#
# Этот файл содержит инструкции для LLM по извлечению структуры
# из российских нормативных правовых актов (федеральные законы, постановления, приказы)

metadata:
  version: "1.0.0"
  created: "2025-12-31"
  author: "Manual verification phase"
  target_optimizer: "DSPy MIPROv2 (GEPA)"
  manual_verified: true
  iterations: 0  # Will be updated by DSPy

# Общее описание задачи
task_description:
  ru: |
    Извлечь иерархическую структуру из российского нормативного правового акта.
    Определить: главы, параграфы, статьи, части, пункты, подпункты.
    Выявить недействующие нормы (утратившие силу).
  en: |
    Extract hierarchical structure from Russian normative legal act.
    Identify: chapters, paragraphs, articles, parts, clauses, subclauses.
    Detect invalid (repealed) provisions.

# Иерархия структуры нормативных актов
hierarchy:
  description: "Типичная иерархия российского федерального закона"
  levels:
    - level: 1
      name_ru: "Глава"
      name_en: "Chapter"
      marker_patterns:
        - pattern: 'Глава\s+(\d+)\.\s*([А-ЯЁ][А-ЯЁ\s,()]+)'
          groups:
            1: "number"
            2: "title"
        - pattern: 'ГЛАВА\s+([IVXLCDM]+)\.\s*(.+)'
          groups:
            1: "roman_number"
            2: "title"
          note: "Римские цифры в некоторых документах"
      required: true
      typical_count: "5-15"

    - level: 2
      name_ru: "Параграф"
      name_en: "Paragraph/Section"
      marker_patterns:
        - pattern: '§\s*(\d+(?:\.\d+)?)\.\s*([^§Г]+?)(?=Статья|\Z)'
          groups:
            1: "number"
            2: "title"
        - pattern: '&#167;\s*(\d+(?:\.\d+)?)\.\s*(.+)'
          groups:
            1: "number"
            2: "title"
          note: "HTML entity в XML файлах"
      required: false
      note: "Не во всех законах. В 44-ФЗ только в Главе 3"

    - level: 3
      name_ru: "Статья"
      name_en: "Article"
      marker_patterns:
        - pattern: 'Статья\s+(\d+(?:\.\d+)?)\.\s*([А-ЯЁ][^§Г]+?)(?=Статья\s+\d|Глава\s+\d|§\s*\d|\Z)'
          groups:
            1: "number"
            2: "title"
      required: true
      typical_count: "50-150"
      numbering_variants:
        - type: "simple"
          example: "Статья 1"
        - type: "decimal"
          example: "Статья 24.1"
        - type: "triple"
          example: "Статья 110.2"

    - level: 4
      name_ru: "Часть"
      name_en: "Part"
      marker_patterns:
        - pattern: '^(\d+)\.\s+(.+)'
          groups:
            1: "number"
            2: "text"
        - pattern: '^\d+\s*\.\s+(.+)'
          note: "С пробелом перед точкой (редкий артефакт)"
      required: false
      context: "Внутри статьи"
      typical_count_per_article: "1-30"

    - level: 5
      name_ru: "Пункт"
      name_en: "Clause"
      marker_patterns:
        - pattern: '^(\d+)\)\s+(.+)'
          groups:
            1: "number"
            2: "text"
      required: false
      context: "Внутри части статьи"
      typical_count_per_part: "1-20"

    - level: 6
      name_ru: "Подпункт"
      name_en: "Subclause"
      marker_patterns:
        - pattern: '^([а-яё])\)\s+(.+)'
          groups:
            1: "letter"
            2: "text"
      required: false
      context: "Внутри пункта"
      allowed_letters: ["а", "б", "в", "г", "д", "е", "ж", "з", "и", "к", "л", "м"]
      typical_count_per_clause: "2-10"

    - level: 6.1
      name_ru: "Подчасть"
      name_en: "Subpart"
      marker_patterns:
        - pattern: '^(\d+\.\d+)\)\s+(.+)'
          groups:
            1: "compound_number"
            2: "text"
      required: false
      note: "Редко, например в статье 95 44-ФЗ"
      example: "1.1) при проведении конкурсов..."

# Маркеры недействующих норм
invalidity_detection:
  description: "Паттерны для определения утративших силу норм"
  patterns:
    - pattern: 'утратила?\s+силу'
      type: "full_invalidation"
      confidence: 0.99
    - pattern: 'признана?\s+утратившей\s+силу'
      type: "full_invalidation"
      confidence: 0.99
    - pattern: 'не\s+применяется'
      type: "non_applicable"
      confidence: 0.95
    - pattern: 'утратил[ао]?\s+силу\s+с\s+(\d{2}\.\d{2}\.\d{4})'
      type: "dated_invalidation"
      confidence: 0.99
      groups:
        1: "invalidation_date"
    - pattern: 'Федеральн\w+\s+закон\w*\s+от\s+\d{2}\.\d{2}\.\d{4}'
      type: "amendment_reference"
      confidence: 0.9
      note: "Ссылка на ФЗ, внёсший изменения"

# Временные маркеры
temporal_markers:
  description: "Паттерны для извлечения дат и временных периодов"
  patterns:
    - pattern: 'от\s+(\d{2}\.\d{2}\.\d{4})'
      field: "publication_date"
      description: "Дата принятия документа"
    - pattern: 'вступает\s+в\s+силу\s+с\s+(\d{2}\.\d{2}\.\d{4})'
      field: "effective_date"
      description: "Дата вступления в силу"
    - pattern: 'вступает\s+в\s+силу\s+по\s+истечении\s+(\d+)\s+(дней?|месяц\w*|года?|лет)'
      field: "effective_period"
      description: "Период до вступления в силу"
    - pattern: 'в\s+редакции\s+(?:Федерального\s+закона\s+)?от\s+(\d{2}\.\d{2}\.\d{4})'
      field: "amendment_date"
      description: "Дата редакции"

# Специфика форматов источников
source_formats:
  consultantplus_xml:
    description: "XML экспорт из КонсультантПлюс"
    encoding: "UTF-8"
    special_entities:
      paragraph_symbol: "&#167;"
      quote_left: "&#34;"
      quote_right: "&#34;"
    text_extraction: "Извлечь текст из <w:t> тегов"
    bold_marker: "<w:b/>"
    note: "Заголовки обычно выделены полужирным"

  garant_html:
    description: "HTML экспорт из ГАРАНТ"
    encoding: "UTF-8"
    structure_markers: "CSS классы для структурных элементов"

  plain_text:
    description: "Текстовый формат"
    encoding: "UTF-8"
    note: "Структура определяется только по текстовым маркерам"

# Правила парсинга
parsing_rules:
  - rule: "chapter_first"
    description: "Главы всегда идут первыми в иерархии"
    priority: 1

  - rule: "paragraph_in_chapter"
    description: "Параграфы (§) могут быть ТОЛЬКО внутри глав"
    priority: 2

  - rule: "article_in_paragraph_or_chapter"
    description: "Статьи могут быть внутри параграфа ИЛИ напрямую в главе"
    priority: 3

  - rule: "parts_in_article"
    description: "Части (1., 2., 3.) только внутри статей"
    priority: 4

  - rule: "clauses_in_parts"
    description: "Пункты (1), 2), 3)) только внутри частей"
    priority: 5

  - rule: "subclauses_in_clauses"
    description: "Подпункты (а), б), в)) только внутри пунктов"
    priority: 6

  - rule: "no_paragraph_in_subclause"
    description: "Параграф НЕ может быть внутри подпункта"
    priority: 7
    type: "constraint"

# Уровни автоматизации
automation_levels:
  manual:
    description: "Человек проверяет все извлечения"
    confidence_threshold: 0.0
    actions:
      - "Извлечь структуру"
      - "Показать человеку для верификации"
      - "Записать ошибки как training signals"

  semi_auto:
    description: "Человек проверяет только низкую уверенность"
    confidence_threshold: 0.8
    actions:
      - "Извлечь структуру"
      - "Если confidence >= 0.8: автопринять"
      - "Если confidence < 0.8: человеческая верификация"

  auto:
    description: "Полностью автоматически с мониторингом"
    confidence_threshold: 0.95
    actions:
      - "Извлечь структуру"
      - "Если confidence >= 0.95: автопринять"
      - "Если confidence < 0.8: человеческая верификация"
      - "0.8 <= confidence < 0.95: автопринять с флагом review_later"

# Примеры для few-shot learning
examples:
  - input: "Глава 1. ОБЩИЕ ПОЛОЖЕНИЯ\nСтатья 1. Сфера применения..."
    output:
      type: "chapter"
      number: 1
      title: "ОБЩИЕ ПОЛОЖЕНИЯ"
      children:
        - type: "article"
          number: "1"
          title: "Сфера применения..."

  - input: "§ 1. Общие положения\nСтатья 24. Способы определения..."
    output:
      type: "paragraph"
      number: "1"
      title: "Общие положения"
      children:
        - type: "article"
          number: "24"
          title: "Способы определения..."

  - input: "1. Настоящий закон регулирует...\n2. Настоящий закон не применяется..."
    output:
      type: "parts_list"
      items:
        - type: "part"
          number: 1
          text: "Настоящий закон регулирует..."
        - type: "part"
          number: 2
          text: "Настоящий закон не применяется..."

  - input: "Статья 13. Утратила силу с 1 октября 2019 года. - Федеральный закон от..."
    output:
      type: "article"
      number: "13"
      title: "Утратила силу"
      invalid: true
      invalidation_date: "2019-10-01"
      invalidation_reason: "Федеральный закон"

# DSPy конфигурация
dspy_config:
  optimizer: "MIPROv2"
  model: "minimax-m2.1"
  signature: |
    document_text: str -> structure: dict, confidence: float
  metric: "structure_accuracy"
  trainset_size: 50
  valset_size: 20

# Валидация результатов
validation:
  required_fields:
    - "type"
    - "number"
  optional_fields:
    - "title"
    - "children"
    - "invalid"
  constraints:
    - "Номер статьи должен быть уникален в документе"
    - "Номер главы должен быть последовательным (1, 2, 3...)"
    - "Подпункты используют только кириллические буквы"

# Версионирование промпта
changelog:
  - version: "1.0.0"
    date: "2025-12-31"
    changes:
      - "Начальная версия на основе ручного анализа 44-ФЗ"
      - "Добавлены все уровни иерархии"
      - "Добавлены маркеры недействующих норм"
      - "Добавлены временные маркеры"
      - "Добавлены примеры для few-shot"
